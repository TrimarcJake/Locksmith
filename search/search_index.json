{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":""},{"location":"#locksmith","title":"Locksmith","text":"<pre><code> _       _____  _______ _     _ _______ _______ _____ _______ _     _\n |      |     | |       |____/  |______ |  |  |   |      |    |_____|\n |_____ |_____| |_____  |    \\_ ______| |  |  | __|__    |    |     |\n     .--.                  .--.                  .--.\n    /.-. '----------.     /.-. '----------.     /.-. '----------.\n    \\'-' .---'-''-'-'     \\'-' .--'--''-'-'     \\'-' .--'--'-''-'\n     '--'                  '--'                  '--'\n</code></pre> <p>A small tool built to find and fix common misconfigurations in Active Directory Certificate Services.</p> <p> </p>"},{"location":"#contents","title":"Contents","text":"<ol> <li>Installation</li> <li>Run Locksmith</li> <li>Mode 0</li> <li>Mode 1</li> <li>Mode 2</li> <li>Mode 3</li> <li>Mode 4</li> <li>Scans </li> </ol>"},{"location":"#installation","title":"Installation","text":""},{"location":"#prerequisites","title":"Prerequisites","text":"<ol> <li>Locksmith must be run on a domain joined system.</li> <li>The ActiveDirectory and ServerManager PowerShell modules must be installed before importing the Locksmith module.</li> <li>Administrative rights may be required for some checks and for remediation.</li> </ol>"},{"location":"#standard-module-installation","title":"Standard Module Installation","text":"<p>Open a PowerShell prompt and install Locksmith from the PowerShell Gallery:</p> <pre><code>Install-Module -Name Locksmith -Scope CurrentUser\n</code></pre>"},{"location":"#alternative-installation-methods","title":"Alternative Installation Methods","text":"<ol> <li>Download and Use the Module Without Installing It</li> <li>Download the latest module version.</li> <li>Open a PowerShell prompt to the location of the extracted file and run:    <code>powershell    Unblock-File .\\Locksmith.zip # if necessary to unblock the download    Expand-Archive .\\Locksmith.zip    Import-Module .\\Locksmith\\Locksmith.psd1    Invoke-Locksmith</code></li> <li>Download the Standalone Script Without Module</li> <li>Download the latest monolithic (all-in-one) script version: https://github.com/TrimarcJake/Locksmith/releases/latest/download/Invoke-Locksmith.zip.</li> <li>Open a PowerShell prompt to the location of the downloaded file and run:    <code>powershell    Unblock-File .\\Invoke-Locksmith.zip    Expand-Archive .\\Invoke-Locksmith.zip -DestinationPath .\\    .\\Invoke-Locksmith.ps1</code> </li> </ol>"},{"location":"#run-locksmith","title":"Run Locksmith","text":"<p>There are several modes you can chose from when running <code>Invoke-Locksmith</code>. You can also use the Scans parameter to choose which scans you want to invoke.</p> <p></p>"},{"location":"#mode-0-identify-issues-output-to-console-default","title":"Mode 0: Identify Issues, Output to Console (Default)","text":"<p>Running <code>Invoke-Locksmith.ps1</code> with no parameters or with <code>-Mode 0</code> will scan the current Active Directory forest and output all discovered AD CS issues to the console in Table format.</p> <pre><code># Module Syntax\nInvoke-Locksmith\n</code></pre> <pre><code># Script Syntax\n.\\Invoke-Locksmith.ps1\n</code></pre> <p>Example Output for Mode 0: https://github.com/TrimarcJake/Locksmith/blob/main/examples/Mode0.md</p> <p></p>"},{"location":"#mode-1-identify-issues-and-fixes-output-to-console","title":"Mode 1: Identify Issues and Fixes, Output to Console","text":"<p>This mode scans the current forest and outputs all discovered AD CS issues and possible fixes to the console in List format.</p> <pre><code># Module Syntax\nInvoke-Locksmith -Mode 1\n</code></pre> <pre><code># Script Syntax\n.\\Invoke-Locksmith.ps1 -Mode 1\n</code></pre> <p>Example Output for Mode 1: https://github.com/TrimarcJake/Locksmith/blob/main/examples/Mode1.md</p> <p></p>"},{"location":"#mode-2-identify-issues-output-to-csv","title":"Mode 2: Identify Issues, Output to CSV","text":"<p>Locksmith Mode 2 scans the current forest and outputs all discovered AD CS issues to ADCSIssues.CSV in the present working directory.</p> <pre><code># Module Syntax\nInvoke-Locksmith -Mode 2\n</code></pre> <pre><code># Script Syntax\n.\\Invoke-Locksmith.ps1 -Mode 2\n</code></pre> <p>Example Output for Mode 2: https://github.com/TrimarcJake/Locksmith/blob/main/examples/Mode2.md</p> <p></p>"},{"location":"#mode-3-identify-issues-and-fixes-output-to-csv","title":"Mode 3: Identify Issues and Fixes, Output to CSV","text":"<p>In Mode 3, Locksmith scans the current forest and outputs all discovered AD CS issues and example fixes to ADCSRemediation.CSV in the present working directory.</p> <pre><code># Module Syntax\nInvoke-Locksmith -Mode 3\n</code></pre> <pre><code># Script Syntax\n.\\Invoke-Locksmith.ps1 -Mode 3\n</code></pre> <p>Example Output for Mode 3: https://github.com/TrimarcJake/Locksmith/blob/main/examples/Mode3.md</p> <p></p>"},{"location":"#mode-4-fix-all-issues","title":"Mode 4: Fix All Issues","text":"<p>Mode 4 is the \"easy button.\" Running Locksmith in Mode 4 will identify all misconfigurations and offer to fix each issue. If there is any possible operational impact, Locksmith will warn you.</p> <pre><code># Module Syntax\nInvoke-Locksmith -Mode 4\n</code></pre> <pre><code># Script Syntax\n.\\Invoke-Locksmith.ps1 -Mode 4\n</code></pre> <p>Example Output for Mode 4: https://github.com/TrimarcJake/Locksmith/blob/main/examples/Mode4.md</p> <p></p>"},{"location":"#scans-select-which-scans-to-invoke","title":"Scans: Select Which Scans to Invoke","text":"<p>Use the <code>-Scans</code> parameter to choose which vulnerabilities to scan for. Acceptable values include <code>All</code>, <code>Auditing</code>, <code>ESC1</code>, <code>ESC2</code>, <code>ESC3</code>, <code>ESC4</code>, <code>ESC5</code>, <code>ESC6</code>, <code>ESC8</code>, <code>ESC11</code>, <code>ESC13</code>, <code>ESC15</code>, <code>EKEUwu</code>, or <code>PromptMe</code>. The <code>PromptMe</code> option presents an interactive list allowing you to select one or more scans.</p> <pre><code># Run all scans\nInvoke-Locksmith -Scan All\n</code></pre> <pre><code># Prompt the user for a list of scans to select\nInvoke-Locksmith.ps1 -Scans PromptMe\n</code></pre> <pre><code># Scan for ESC1 vulnerable paths\nInvoke-Locksmith.ps1 -Scans ESC1\n</code></pre> <pre><code># Scan for ESC1, ESC2, and ESC8 vulnerable paths\nInvoke-Locksmith.ps1 -Scans ESC1,ESC2,ESC8\n</code></pre> <p>Thank you for using Locksmith! \ud83d\udc9c</p>"},{"location":"Invoke-Locksmith/","title":"Invoke-Locksmith","text":""},{"location":"Invoke-Locksmith/#synopsis","title":"SYNOPSIS","text":"<p>Finds the most common malconfigurations of Active Directory Certificate Services (AD CS).</p>"},{"location":"Invoke-Locksmith/#syntax","title":"SYNTAX","text":"<pre><code>Invoke-Locksmith [[-Mode] &lt;Int32&gt;] [[-Scans] &lt;Array&gt;] [[-OutputPath] &lt;String&gt;] [[-Credential] &lt;PSCredential&gt;]\n [&lt;CommonParameters&gt;]\n</code></pre>"},{"location":"Invoke-Locksmith/#description","title":"DESCRIPTION","text":"<p>Locksmith uses the Active Directory (AD) Powershell (PS) module to identify 10 misconfigurations commonly found in Enterprise mode AD CS installations.</p>"},{"location":"Invoke-Locksmith/#examples","title":"EXAMPLES","text":""},{"location":"Invoke-Locksmith/#example-1","title":"EXAMPLE 1","text":"<pre><code>Invoke-Locksmith -Mode 0 -Scans All -OutputPath 'C:\\Temp'\n</code></pre> <p>Finds all malconfigurations and displays them in the console.</p>"},{"location":"Invoke-Locksmith/#example-2","title":"EXAMPLE 2","text":"<pre><code>Invoke-Locksmith -Mode 2 -Scans All -OutputPath 'C:\\Temp'\n</code></pre> <p>Finds all malconfigurations and displays them in the console. The findings are saved in a CSV file in C:\\Temp.</p>"},{"location":"Invoke-Locksmith/#parameters","title":"PARAMETERS","text":""},{"location":"Invoke-Locksmith/#-mode","title":"-Mode","text":"<p>Specifies sets of common script execution modes.</p> <p>-Mode 0 Finds any malconfigurations and displays them in the console. No attempt is made to fix identified issues.</p> <p>-Mode 1 Finds any malconfigurations and displays them in the console. Displays example Powershell snippet that can be used to resolve the issue. No attempt is made to fix identified issues.</p> <p>-Mode 2 Finds any malconfigurations and writes them to a series of CSV files. No attempt is made to fix identified issues.</p> <p>-Mode 3 Finds any malconfigurations and writes them to a series of CSV files. Creates code snippets to fix each issue and writes them to an environment-specific custom .PS1 file. No attempt is made to fix identified issues.</p> <p>-Mode 4 Finds any malconfigurations and creates code snippets to fix each issue. Attempts to fix all identified issues. This mode may require high-privileged access.</p> <pre><code>Type: Int32\nParameter Sets: (All)\nAliases:\n\nRequired: False\nPosition: 1\nDefault value: 0\nAccept pipeline input: False\nAccept wildcard characters: False\n</code></pre>"},{"location":"Invoke-Locksmith/#-scans","title":"-Scans","text":"<p>Specify which scans you want to run. Available scans: 'All' or Auditing, ESC1, ESC2, ESC3, ESC4, ESC5, ESC6, ESC8, or 'PromptMe'</p> <p>-Scans All Run all scans (default).</p> <p>-Scans PromptMe Presents a grid view of the available scan types that can be selected and run them after you click OK.</p> <pre><code>Type: Array\nParameter Sets: (All)\nAliases:\n\nRequired: False\nPosition: 2\nDefault value: All\nAccept pipeline input: False\nAccept wildcard characters: False\n</code></pre>"},{"location":"Invoke-Locksmith/#-outputpath","title":"-OutputPath","text":"<p>Specify the path where you want to save reports and mitigation scripts.</p> <pre><code>Type: String\nParameter Sets: (All)\nAliases:\n\nRequired: False\nPosition: 3\nDefault value: $PWD\nAccept pipeline input: False\nAccept wildcard characters: False\n</code></pre>"},{"location":"Invoke-Locksmith/#-credential","title":"-Credential","text":"<p>The credential to use for working with ADCS.</p> <pre><code>Type: PSCredential\nParameter Sets: (All)\nAliases:\n\nRequired: False\nPosition: 4\nDefault value: None\nAccept pipeline input: False\nAccept wildcard characters: False\n</code></pre>"},{"location":"Invoke-Locksmith/#commonparameters","title":"CommonParameters","text":"<p>This cmdlet supports the common parameters: -Debug, -ErrorAction, -ErrorVariable, -InformationAction, -InformationVariable, -OutBuffer, -OutVariable, -PipelineVariable, -Verbose, -WarningAction, -WarningVariable, and -ProgressAction.  For more information, see about_CommonParameters.</p>"},{"location":"Invoke-Locksmith/#inputs","title":"INPUTS","text":""},{"location":"Invoke-Locksmith/#none-you-cannot-pipe-objects-to-invoke-locksmithps1","title":"None. You cannot pipe objects to Invoke-Locksmith.ps1.","text":""},{"location":"Invoke-Locksmith/#outputs","title":"OUTPUTS","text":""},{"location":"Invoke-Locksmith/#output-types","title":"Output types:","text":""},{"location":"Invoke-Locksmith/#1-console-display-of-identified-issues","title":"1. Console display of identified issues.","text":""},{"location":"Invoke-Locksmith/#2-console-display-of-identified-issues-and-their-fixes","title":"2. Console display of identified issues and their fixes.","text":""},{"location":"Invoke-Locksmith/#3-csv-containing-all-identified-issues","title":"3. CSV containing all identified issues.","text":""},{"location":"Invoke-Locksmith/#4-csv-containing-all-identified-issues-and-their-fixes","title":"4. CSV containing all identified issues and their fixes.","text":""},{"location":"Invoke-Locksmith/#notes","title":"NOTES","text":"<p>The Windows PowerShell cmdlet Restart-Service requires RunAsAdministrator.</p>"},{"location":"Invoke-Locksmith/#related-links","title":"RELATED LINKS","text":""},{"location":"Locksmith/","title":"Locksmith Module","text":""},{"location":"Locksmith/#description","title":"Description","text":"<p>A small tool to find and fix common misconfigurations in Active Directory Certificate Services.</p>"},{"location":"Locksmith/#locksmith-cmdlets","title":"Locksmith Cmdlets","text":""},{"location":"Locksmith/#invoke-locksmith","title":"Invoke-Locksmith","text":"<p>A small tool to find and fix common misconfigurations in Active Directory Certificate Services.</p>"},{"location":"Examples/Mode0/","title":"Mode0","text":"<p>```  _       _ _ _     _ _ _ _ _     _  |      |     | |       |_/  |__ |  |  |   |      |    ||  | |_____| |_____  |    _ ______| |  |  | |__    |    |     |      .--.                  .--.                  .--.     /.-. '----------.     /.-. '----------.     /.-. '----------.     \\'-' .---'-''-'-'     \\'-' .--'--''-'-'     \\'-' .--'--'-''-'      '--'                  '--'                  '--'</p>"},{"location":"Examples/Mode0/#auditing-issues","title":"#### Auditing Issues","text":"<p>Technique Name         Issue --------- ----         ----- DETECT    horse-DC1-CA Auditing is not fully enabled. Current value is 0</p>"},{"location":"Examples/Mode0/#esc1-misconfigured-certificate-template","title":"#### ESC1 - Misconfigured Certificate Template","text":"<p>Technique Name            Issue --------- ----            ----- ESC1      ESC1-Vulnerable HORSE\\kari can enroll in this Client Authentication template using a SAN without Manager Approval</p>"},{"location":"Examples/Mode0/#esc2-misconfigured-certificate-template","title":"#### ESC2 - Misconfigured Certificate Template","text":"<p>Technique Name            Issue --------- ----            ----- ESC2      ESC2-Vulnerable NT AUTHORITY\\Authenticated Users can request a SubCA certificate without Manager Approval</p>"},{"location":"Examples/Mode0/#esc4-vulnerable-certificate-template-access-control","title":"#### ESC4 - Vulnerable Certificate Template Access Control","text":"<p>Technique Name                    Issue --------- ----                    ----- ESC4      User                    NT AUTHORITY\\Authenticated Users has GenericAll rights on this template ESC4      User                    HORSE\\Domain Users has GenericAll rights on this template</p>"},{"location":"Examples/Mode0/#esc5-vulnerable-pki-object-access-control","title":"#### ESC5 - Vulnerable PKI Object Access Control","text":"<p>Technique Name         Issue --------- ----         ----- ESC5      horse-DC1-CA HORSE\\kari has CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete,                        GenericRead, WriteDacl, WriteOwner rights on this object ESC5      DC1          HORSE\\kari has GenericAll rights on this object</p>"},{"location":"Examples/Mode0/#esc6-editf_attributesubjectaltname2","title":"#### ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2","text":"<p>Technique Name         Issue --------- ----         ----- ESC6      horse-DC1-CA EDITF_ATTRIBUTESUBJECTALTNAME2 is enabled.</p>"},{"location":"Examples/Mode0/#esc8-http-enrollment-enabled","title":"#### ESC8 - HTTP Enrollment Enabled","text":"<p>Technique Name         Issue --------- ----         ----- ESC8      horse-DC1-CA HTTP enrollment is enabled.</p>"},{"location":"Examples/Mode1/","title":"Mode1","text":"<p>```  _       _ _ _     _ _ _ _ _     _  |      |     | |       |_/  |__ |  |  |   |      |    ||  | |_____| |_____  |    _ ______| |  |  | |__    |    |     |      .--.                  .--.                  .--.     /.-. '----------.     /.-. '----------.     /.-. '----------.     \\'-' .---'-''-'-'     \\'-' .--'--''-'-'     \\'-' .--'--'-''-'      '--'                  '--'                  '--'</p>"},{"location":"Examples/Mode1/#auditing-issues","title":"#### Auditing Issues","text":"<p>Technique         : DETECT Name              : horse-DC1-CA DistinguishedName : CN=horse-DC1-CA,CN=Enrollment Services,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local Issue             : Auditing is not fully enabled. Current value is 0 Fix               : certutil -config 'DC1.horse.local\\horse-DC1-CA' -setreg 'CA\\AuditFilter' 127; Invoke-Command                     -ComputerName 'DC1.horse.local' -ScriptBlock { Get-Service -Name 'certsvc' | Restart-Service                     -Force }</p>"},{"location":"Examples/Mode1/#esc1-misconfigured-certificate-template","title":"#### ESC1 - Misconfigured Certificate Template","text":"<p>Technique         : ESC1 Name              : ESC1-Vulnerable DistinguishedName : CN=ESC1-Vulnerable,CN=Certificate Templates,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local Issue             : HORSE\\kari can enroll in this Client Authentication template using a SAN without Manager                     Approval Fix               : Get-ADObject 'CN=ESC1-Vulnerable,CN=Certificate Templates,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local' | Set-ADObject -Replace                     @{'msPKI-Certificate-Name-Flag' = 0}</p>"},{"location":"Examples/Mode1/#esc2-misconfigured-certificate-template","title":"#### ESC2 - Misconfigured Certificate Template","text":"<p>Technique         : ESC2 Name              : ESC2-Vulnerable DistinguishedName : CN=ESC2-Vulnerable,CN=Certificate Templates,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local Issue             : NT AUTHORITY\\Authenticated Users can request a SubCA certificate without Manager Approval Fix               : Get-ADObject 'CN=ESC2-Vulnerable,CN=Certificate Templates,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local' | Set-ADObject -Replace                     @{'msPKI-Certificate-Name-Flag' = 0}</p>"},{"location":"Examples/Mode1/#esc4-vulnerable-certificate-template-access-control","title":"#### ESC4 - Vulnerable Certificate Template Access Control","text":"<p>Technique         : ESC4 Name              : User DistinguishedName : CN=User,CN=Certificate Templates,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local Issue             : NT AUTHORITY\\Authenticated Users has GenericAll rights on this template Fix               : [Available in experimental branch]</p> <p>Technique         : ESC4 Name              : User DistinguishedName : CN=User,CN=Certificate Templates,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local Issue             : HORSE\\Domain Users has GenericAll rights on this template Fix               : [Available in experimental branch]</p>"},{"location":"Examples/Mode1/#esc5-vulnerable-pki-object-access-control","title":"#### ESC5 - Vulnerable PKI Object Access Control","text":"<p>Technique         : ESC5 Name              : horse-DC1-CA DistinguishedName : CN=horse-DC1-CA,CN=Enrollment Services,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local Issue             : HORSE\\kari has CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead,                     WriteDacl, WriteOwner rights on this object Fix               : [Available in experimental branch]</p> <p>Technique         : ESC5 Name              : DC1 DistinguishedName : CN=DC1,CN=AIA,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local Issue             : HORSE\\kari has GenericAll rights on this object Fix               : [Available in experimental branch]</p>"},{"location":"Examples/Mode1/#esc6-editf_attributesubjectaltname2","title":"#### ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2","text":"<p>Technique         : ESC6 Name              : horse-DC1-CA DistinguishedName : CN=horse-DC1-CA,CN=Enrollment Services,CN=Public Key                     Services,CN=Services,CN=Configuration,DC=horse,DC=local Issue             : EDITF_ATTRIBUTESUBJECTALTNAME2 is enabled. Fix               : certutil -config DC1.horse.local\\horse-DC1-CA -setreg policy\\EditFlags                     -EDITF_ATTRIBUTESUBJECTALTNAME2; Invoke-Command -ComputerName \"DC1.horse.local\" -ScriptBlock {                     Get-Service -Name 'certsvc' | Restart-Service -Force }</p>"},{"location":"Examples/Mode1/#esc8-http-enrollment-enabled","title":"#### ESC8 - HTTP Enrollment Enabled","text":"<p>Technique           : ESC8 Name                : horse-DC1-CA DistinguishedName   : CN=horse-DC1-CA,CN=Enrollment Services,CN=Public Key                       Services,CN=Services,CN=Configuration,DC=horse,DC=local EnrollmentEndpoints : {http://DC1.horse.local/certsrv/} Issue               : HTTP enrollment is enabled. Fix                 : </p>"},{"location":"Examples/Mode2/","title":"Mode2","text":"<p>``` \"Forest\",\"Name\",\"Issue\" \"horse.local\",\"horse-DC1-CA\",\"Auditing is not fully enabled. Current value is 0\" \"horse.local\",\"ESC1-Vulnerable\",\"HORSE\\kari can enroll in this Client Authentication template using a SAN without Manager Approval\" \"horse.local\",\"ESC2-Vulnerable\",\"NT AUTHORITY\\Authenticated Users can request a SubCA certificate without Manager Approval\" \"horse.local\",\"User\",\"NT AUTHORITY\\Authenticated Users has GenericAll rights on this template\" \"horse.local\",\"User\",\"HORSE\\Domain Users has GenericAll rights on this template\" \"horse.local\",\"horse-DC1-CA\",\"HORSE\\kari has CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner rights on this object\" \"horse.local\",\"DC1\",\"HORSE\\kari has GenericAll rights on this object\" \"horse.local\",\"horse-DC1-CA\",\"EDITF_ATTRIBUTESUBJECTALTNAME2 is enabled.\" \"horse.local\",\"horse-DC1-CA\",\"HTTP enrollment is enabled.\"</p>"},{"location":"Examples/Mode3/","title":"Mode3","text":"<p>``` \"Forest\",\"Name\",\"DistinguishedName\",\"Issue\",\"Fix\" \"horse.local\",\"horse-DC1-CA\",\"CN=horse-DC1-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"Auditing is not fully enabled. Current value is 0\",\"certutil -config 'DC1.horse.local\\horse-DC1-CA' -setreg 'CA\\AuditFilter' 127; Invoke-Command -ComputerName 'DC1.horse.local' -ScriptBlock { Get-Service -Name 'certsvc' | Restart-Service -Force }\" \"horse.local\",\"ESC1-Vulnerable\",\"CN=ESC1-Vulnerable,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"HORSE\\kari can enroll in this Client Authentication template using a SAN without Manager Approval\",\"Get-ADObject 'CN=ESC1-Vulnerable,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local' | Set-ADObject -Replace @{'msPKI-Certificate-Name-Flag' = 0}\" \"horse.local\",\"ESC2-Vulnerable\",\"CN=ESC2-Vulnerable,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"NT AUTHORITY\\Authenticated Users can request a SubCA certificate without Manager Approval\",\"Get-ADObject 'CN=ESC2-Vulnerable,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local' | Set-ADObject -Replace @{'msPKI-Certificate-Name-Flag' = 0}\" \"horse.local\",\"User\",\"CN=User,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"NT AUTHORITY\\Authenticated Users has GenericAll rights on this template\",\"[Available in experimental branch]\" \"horse.local\",\"User\",\"CN=User,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"HORSE\\Domain Users has GenericAll rights on this template\",\"[Available in experimental branch]\" \"horse.local\",\"horse-DC1-CA\",\"CN=horse-DC1-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"HORSE\\kari has CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner rights on this object\",\"[Available in experimental branch]\" \"horse.local\",\"DC1\",\"CN=DC1,CN=AIA,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"HORSE\\kari has GenericAll rights on this object\",\"[Available in experimental branch]\" \"horse.local\",\"horse-DC1-CA\",\"CN=horse-DC1-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"EDITF_ATTRIBUTESUBJECTALTNAME2 is enabled.\",\"certutil -config DC1.horse.local\\horse-DC1-CA -setreg policy\\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2; Invoke-Command -ComputerName \"\"DC1.horse.local\"\" -ScriptBlock { Get-Service -Name 'certsvc' | Restart-Service -Force }\" \"horse.local\",\"horse-DC1-CA\",\"CN=horse-DC1-CA,CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local\",\"HTTP enrollment is enabled.\",\"TBD - Remediate by doing 1, 2, and 3\"</p>"},{"location":"Examples/Mode4/","title":"Mode4","text":""},{"location":"Examples/Mode4/#locksmith-will-prompt-you-to-confirm-each-remediation-action","title":"Locksmith will prompt you to confirm each remediation action.","text":"<pre><code>\n _       _____  _______ _     _ _______ _______ _____ _______ _     _\n |      |     | |       |____/  |______ |  |  |   |      |    |_____|\n |_____ |_____| |_____  |    \\_ ______| |  |  | __|__    |    |     |\n     .--.                  .--.                  .--.\n    /.-. '----------.     /.-. '----------.     /.-. '----------.\n    \\'-' .---'-''-'-'     \\'-' .--'--''-'-'     \\'-' .--'--'-''-'\n     '--'                  '--'                  '--'\n\nAttempting to fully enable AD CS auditing on horse-DC1-CA...\nThis should have little impact on your environment.\n\nCommand(s) to be run:\nPS&gt; certutil -config 'DC1.horse.local\\horse-DC1-CA' -setreg 'CA\\AuditFilter' 127; Invoke-Command -ComputerName 'DC1.horse.local' -ScriptBlock { Get-Service -Name 'certsvc' | Restart-Service -Force }\n\nWARNING: If you continue, this script will attempt to fix this issue.\n\nConfirm\nContinue with this operation?\n[Y] Yes  [A] Yes to All  [H] Halt Command  [S] Suspend  [?] Help (default is \"Y\"):\n</code></pre>"},{"location":"Examples/Mode4/#locksmith-will-warn-you-if-there-are-possible-operational-impacts","title":"Locksmith will warn you if there are possible operational impacts.","text":"<pre><code>\n _       _____  _______ _     _ _______ _______ _____ _______ _     _\n |      |     | |       |____/  |______ |  |  |   |      |    |_____|\n |_____ |_____| |_____  |    \\_ ______| |  |  | __|__    |    |     |\n     .--.                  .--.                  .--.\n    /.-. '----------.     /.-. '----------.     /.-. '----------.\n    \\'-' .---'-''-'-'     \\'-' .--'--''-'-'     \\'-' .--'--'-''-'\n     '--'                  '--'                  '--'\n\nAttempting to enable Manager Approval on the ESC1-Vulnerable template...\n\nCommand(s) to be run:\nPS&gt; Get-ADObject 'CN=ESC1-Vulnerable,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local' | Set-ADObject -Replace @{'msPKI-Certificate-Name-Flag' = 0}\n\nWARNING: This could cause some services to stop working until certificates are approved.\nIf you continue this script will attempt to fix this issues.\n\nConfirm\nContinue with this operation?\n[Y] Yes  [A] Yes to All  [H] Halt Command  [S] Suspend  [?] Help (default is \"Y\"):\n</code></pre>"},{"location":"Examples/Mode4/#example-revert-script-for-the-two-examples-shown-above","title":"Example Revert Script for the two examples shown above:","text":"<pre><code>&lt;#\nScript to revert changes performed by Locksmith\nCreated 05/13/2023 09:08:06\n#&gt;\ncertutil -config DC1.horse.local\\horse-DC1-CA -setreg CA\\AuditFilter  0; Invoke-Command -ComputerName 'DC1.horse.local' -ScriptBlock { Get-Service -Name 'certsvc' | Restart-Service -Force }\nGet-ADObject 'CN=ESC1-Vulnerable,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=horse,DC=local' | Set-ADObject -Replace @{'msPKI-Certificate-Name-Flag' = 1}\n</code></pre>"},{"location":"Flowcharts/Auditing/","title":"Auditing","text":"<pre><code>---\ntitle: Auditing\n---\nflowchart LR\n    FullyEnabled[Fully Enabled] -- Yes --&gt; NoFinding[No Finding]\n    FullyEnabled -- No --&gt; Info\n</code></pre>"},{"location":"Flowcharts/ESC1/","title":"ESC1","text":"<pre><code>---\ntitle: ESC1 - Subject Alternative Name (SAN)\n---\nflowchart LR\n    PrincipalType{PrincipalType} --&gt;|User| UserType[\"User Type\"];\n            UserType == AD Admin ==&gt; ADAUPriority(Low);\n            UserType -- Builtin/PKI Admin --&gt; BIAUPriority(Medium);\n            UserType -- User --&gt; UserPriority(High);\n    PrincipalType --&gt;|Group| GroupType(\"Group Type\");\n            GroupType -- AD Admins --&gt; ADASize(No Finding);\n            GroupType -- Builtin/PKI Admins --&gt; BIASize(BIA Group Size);\n                BIASize -- Empty/Small --&gt; BIAEGPriority(Low);\n                BIASize -- Medium/Large --&gt; BIAMGPriority(Medium);\n            GroupType -- Regular Users --&gt; UsersSize(User Group Size);\n                UsersSize -- Empty/Small --&gt; UsersEGPriority(High);\n                UsersSize -- Medium/Large --&gt; UsersMGPriority(Critical);\n    PrincipalType --&gt;|gMSA| gMSAType(gMSA Type);\n            gMSAType -- Any --&gt; gMSAPriority((No Finding));\n</code></pre>"},{"location":"Flowcharts/ESC2/","title":"ESC2","text":"<pre><code>---\ntitle: ESC2 - Subordinate Certification Authority (SubCA)\n---\nflowchart LR\n    PrincipalType --&gt;|User| UserType[\"User Type\"];\n            UserType -- AD Admin --&gt; ADAUPriority(Low);\n            UserType -- Builtin/PKI Admin --&gt; BIAUPriority(Medium);\n            UserType -- User --&gt; UserPriority(High);\n    PrincipalType --&gt;|Group| GroupType(\"Group Type\");\n            GroupType -- AD Admins --&gt; ADASize(No Finding);\n            GroupType -- Builtin/PKI Admins --&gt; BIASize(BIA Group Size);\n                BIASize -- Empty/Small --&gt; BIAEGPriority(Info);\n                BIASize -- Medium/Large --&gt; BIAMGPriority(Low);\n            GroupType -- Regular Users --&gt; UsersSize(User Group Size);\n                UsersSize -- Empty/Small --&gt; UsersEGPriority(Medium);\n                UsersSize -- Medium/Large --&gt; UsersMGPriority(High);\n    PrincipalType --&gt;|gMSA| gMSAType(gMSA Type);\n            gMSAType -- Any --&gt; gMSAPriority(No Finding);\n</code></pre>"},{"location":"Flowcharts/ESC3/","title":"ESC3","text":"<pre><code>---\ntitle: ESC3 Condition 1 - Enrollment Agent\n---\nflowchart LR\n    PrincipalType --&gt;|User| UserType[\"User Type\"];\n            UserType -- AD Admin --&gt; ADAUPriority(Low);\n            UserType -- Builtin/PKI Admin --&gt; BIAUPriority(Medium);\n            UserType -- User --&gt; UserPriority(High);\n    PrincipalType --&gt;|Group| GroupType(\"Group Type\");\n            GroupType -- AD Admins --&gt; ADASize(No Finding);\n            GroupType -- Builtin/PKI Admins --&gt; BIASize(BIA Group Size);\n                BIASize -- Empty/Small --&gt; BIAEGPriority(No Info);\n                BIASize -- Medium/Large --&gt; BIAMGPriority(Low);\n            GroupType -- Regular Users --&gt; UsersSize(User Group Size);\n                UsersSize -- Empty/Small --&gt; UsersEGPriority(Low);\n                UsersSize -- Medium/Large --&gt; UsersMGPriority(Medium);\n    PrincipalType --&gt;|gMSA| gMSAType(gMSA Type);\n            gMSAType -- Any --&gt; gMSAPriority(No Finding);\n</code></pre>"},{"location":"Flowcharts/ESC4/","title":"ESC4","text":"<pre><code>---\ntitle: ESC4 - Templates w/Dangerous ACLs or Ownership\n---\nflowchart LR\n    PrincipalType --&gt;|User| UserType[\"User Type\"];\n            UserType -- AD Admin --&gt; ADAUPriority(Low);\n            UserType -- Builtin/PKI Admin --&gt; BIAUPriority(Medium);\n            UserType -- User --&gt; UserPriority(High);\n    PrincipalType --&gt;|Group| GroupType(\"Group Type\");\n            GroupType -- AD Admins --&gt; ADASize(No Finding);\n            GroupType -- Builtin/PKI Admins --&gt; BIASize(BIA Group Size);\n                BIASize -- Empty/Small --&gt; BIAEGPriority(Info);\n                BIASize -- Medium/Large --&gt; BIAMGPriority(Low);\n            GroupType -- Regular Users --&gt; UsersSize(User Group Size);\n                UsersSize -- Empty/Small --&gt; UsersEGPriority(Medium);\n                UsersSize -- Medium/Large --&gt; UsersMGPriority(High);\n    PrincipalType --&gt;|gMSA| gMSAType(gMSA Type);\n            gMSAType -- Any --&gt; gMSAPriority(No Finding);\n</code></pre>"},{"location":"Flowcharts/ESC5/","title":"ESC5","text":"<pre><code>---\ntitle: ESC5 - Objects w/Dangerous ACLs or Ownership\n---\nflowchart LR\n    PrincipalType --&gt;|User| UserType[\"User Type\"];\n            UserType -- AD Admin --&gt; ADAUPriority(Low);\n            UserType -- Builtin/PKI Admin --&gt; BIAUPriority(Medium);\n            UserType -- User --&gt; UserPriority(High);\n    PrincipalType --&gt;|Group| GroupType(\"Group Type\");\n            GroupType -- AD Admins --&gt; ADASize(No Finding);\n            GroupType -- Builtin/PKI Admins --&gt; BIASize(BIA Group Size);\n                BIASize -- Empty/Small --&gt; BIAEGPriority(Info);\n                BIASize -- Medium/Large --&gt; BIAMGPriority(Low);\n            GroupType -- Regular Users --&gt; UsersSize(User Group Size);\n                UsersSize -- Empty/Small --&gt; UsersEGPriority(Medium);\n                UsersSize -- Medium/Large --&gt; UsersMGPriority(High);\n    PrincipalType --&gt;|gMSA| gMSAType(gMSA Type);\n            gMSAType -- Any --&gt; gMSAPriority(No Finding);\n</code></pre> <pre><code>Note: The severity of this check is highly dependent on the object with the issue.\n</code></pre>"},{"location":"Flowcharts/ESC6/","title":"ESC6","text":"<pre><code>---\ntitle: ESC6 - Dangerous Flag on CA\n---\nflowchart LR\n    FlagSet[\"Flag Set\"] -- Yes --&gt; High\n    FlagSet[\"Flag Set\"] -- No --&gt; NoFinding[No Finding]\n</code></pre> <pre><code>* This check can be improved by checking Domain Controller registries. (Coming soon!)  \nIf StrongMapping is manually disabled on any DC, this becomes a Critical issue.\n</code></pre>"},{"location":"Flowcharts/ESC8/","title":"ESC8","text":"<pre><code>---\ntitle: ESC8 - HTTP/S Enrollment Endpoints\n---\nflowchart LR\n    HTTP/S(HTTP or HTTPS?) -- HTTP --&gt; Critical\n    HTTP/S(HTTP or HTTPS?) -- HTTPS --&gt; Medium[\"Possible: No Finding, Medium\\nCurrent: Medium*\"]\n</code></pre> <pre><code>* With current collection methods, we cannot determine true severity of this configuration.\n  - If NTLM authentication is completely disabled (available at host level or IIS level), this is not a finding.\n  - If EPA is enabled on IIS, the severity is Info.\n  - Otherwise, this is a Medium severity issue.\n</code></pre>"}]}